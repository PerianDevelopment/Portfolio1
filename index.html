<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="page-title">PerianDev — Games Portfolio</title>

  <!-- Favicon uses local icon.png -->
  <link rel="icon" href="icon.png" type="image/png">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #222222;
      --muted: #bdbdbd;
      --text: #eaeaea;
      --brand: #FF382E;
      --card-shadow: 0 6px 18px rgba(0,0,0,0.6);
      --radius: 12px;
      --transition: 240ms cubic-bezier(.2,.9,.2,1);
      --max-width: 1100px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100%;
      background:var(--bg);
      color:var(--text);
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
    }

    .container{max-width:var(--max-width);margin:32px auto;padding:24px;}

    /* Banner */
    .banner{
      display:flex;align-items:center;gap:20px;
      background: linear-gradient(90deg, var(--brand), color-mix(in srgb, var(--brand) 85%, black 15%));
      padding:30px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.55);color:#fff;
    }
    .banner .icon{width:110px;height:110px;flex:0 0 110px;display:flex;align-items:center;justify-content:center;transition:transform var(--transition);}
    .banner .icon img{max-width:100%;max-height:100%;display:block;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.45));}
    .banner h1{margin:0;font-size:clamp(28px,4.5vw,54px);font-weight:900;letter-spacing:-0.02em;text-shadow:0 6px 20px rgba(0,0,0,0.35);}
    .banner-sub{margin-top:8px;color:rgba(255,255,255,0.92);font-weight:500;}
    .banner:hover .icon{transform:translateX(-6px) rotate(-4deg) scale(1.02);}

    /* About (text uses normal page color) */
    .about{margin:28px 0;padding:20px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.03));border-radius:12px;border:1px solid rgba(255,255,255,0.02);box-shadow:var(--card-shadow);}
    .about p{margin:0;color:var(--text);font-size:16px;}

    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.04),transparent);margin:18px 0 22px 0;border-radius:4px;}

    .projects-header{display:flex;flex-direction:column;align-items:flex-start;gap:12px;margin:0 0 8px 0;}
    .section-header{font-size:18px;font-weight:700;display:flex;align-items:center;gap:12px;}
    .section-header .dot{width:10px;height:10px;background:var(--brand);border-radius:50%;box-shadow:0 6px 20px rgba(255,56,46,0.16);}

    /* Text project links */
    .game-links{display:flex;gap:16px;flex-wrap:wrap;align-items:center;}
    .game-link{color:var(--text);font-weight:700;text-decoration:none;position:relative;padding:4px 2px;transition:color var(--transition), transform var(--transition);}
    .game-link::after{content:"";position:absolute;left:0;right:0;bottom:0;height:2px;background:var(--brand);transform:scaleX(0);transform-origin:left center;transition:transform var(--transition);}
    .game-link:hover{color:white;transform:translateY(-2px);}
    .game-link:hover::after{transform:scaleX(1);}

    /* Projects grid */
    .projects{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;}
    @media (max-width:880px){.projects{grid-template-columns:1fr;}}
    @media (max-width:520px){.banner{flex-direction:column;align-items:flex-start;gap:12px;padding:18px;}.banner .icon{width:86px;height:86px;flex:0 0 86px;}}

    .project{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.05));border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.025);box-shadow:var(--card-shadow);transition:transform var(--transition), box-shadow var(--transition);display:flex;flex-direction:column;gap:10px;}
    .project:hover{transform:translateY(-8px);box-shadow:0 16px 38px rgba(0,0,0,0.7);}
    .project-head{display:flex;justify-content:space-between;align-items:center;}
    .project-title{font-weight:800;letter-spacing:-0.01em;margin:0;font-size:18px;color:var(--text);}
    .project-year{font-size:13px;color:var(--muted);background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);}

    .cover-link{display:block;border-radius:10px;overflow:hidden;text-decoration:none;}
    .cover{width:100%;aspect-ratio:4/3;border-radius:10px;overflow:hidden;position:relative;background-size:cover;background-position:center;box-shadow:inset 0 -30px 60px rgba(0,0,0,0.25);transition:transform var(--transition);}
    .project:hover .cover{transform:scale(1.02);}
    .cover-title{position:absolute;left:12px;bottom:12px;z-index:2;font-weight:800;font-size:18px;color:#fff;text-shadow:0 6px 18px rgba(0,0,0,0.6);}
    .cover::after{content:"";position:absolute;left:0;right:0;bottom:0;height:34%;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,0.6));}

    .meta{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px;}
    .meta-item{font-size:13px;}
    .meta-item .label{display:block;color:var(--muted);font-weight:600;font-size:12px;}
    .meta-item .value{color:var(--text);font-weight:500;margin-top:4px;font-size:13px;}

    a.reset{color:var(--brand);text-decoration:none;}
    a.reset:hover{text-decoration:underline;}

    .foot{margin-top:28px;color:var(--muted);font-size:13px;text-align:center;}
  </style>
</head>
<body>
  <div class="container" role="main">

    <!-- Banner (uses local icon.png immediately; remote social.json may replace with icon_transparent) -->
    <header class="banner">
      <div class="icon"><img id="brand-icon" src="icon.png" alt="brand icon" /></div>
      <div style="flex:1;">
        <h1 id="brand-name">PerianDev</h1>
        <div class="banner-sub" id="brand-tagline">Indie games & experiments — playable, polished, irreverent.</div>
      </div>
    </header>

    <!-- About -->
    <section class="about">
      <h2 style="margin:0 0 8px;font-size:16px;font-weight:700;color:var(--text)">About</h2>
      <p id="bio">Perian is a programmer, indie game developer, software engineer and passionate gamer based in Germany. This site focuses on the projects and playable experiences created under the PerianDev brand.</p>
    </section>

    <!-- Divider between About and Projects -->
    <div class="divider"></div>

    <!-- Projects header and quick links -->
    <div class="projects-header">
      <div class="section-header">
        <div class="dot"></div>
        <div>Projects</div>
      </div>

      <nav aria-label="Project quick links">
        <div class="game-links" id="project-links"></div>
      </nav>
    </div>

    <!-- Divider below links -->
    <div class="divider"></div>

    <!-- Projects grid -->
    <section class="projects" id="projects-container"></section>

    <!-- Footer (controlled via website.json/footerText when present) -->
    <div class="foot" id="site-footer">Made with ♥ by PerianDev</div>
  </div>

  <script>
    /* Utility: attempt to fetch a JSON file from multiple parent paths and return the first success.
       Returns { json, url } where url is response.url (absolute) of where the file was fetched from.
       We try: ./name, ../name, ../../name ... up to N levels, then try '/name' as fallback.
    */
    async function fetchJsonFromParents(name, maxDepth = 6) {
      const candidates = [];
      // relative candidates
      let rel = '';
      for (let i = 0; i <= maxDepth; i++) {
        const path = (i === 0) ? `${name}` : `${'../'.repeat(i)}${name}`;
        candidates.push(path);
      }
      // root fallback
      candidates.push('/' + name);

      for (const path of candidates) {
        try {
          const res = await fetch(path, {cache: 'no-cache'});
          if (!res.ok) continue;
          const data = await res.json();
          return { json: data, url: res.url };
        } catch (e) {
          // try next
        }
      }
      throw new Error(`Could not fetch ${name} from any candidate path`);
    }

    // Simple fetch for absolute URLs (like social.json hosted remote)
    async function fetchJsonAbsolute(url) {
      const res = await fetch(url, {cache: 'no-cache'});
      if (!res.ok) throw new Error(`Failed to fetch ${url}: ${res.status}`);
      const json = await res.json();
      return { json, url: res.url };
    }

    // Resolve a possibly-relative URL against a base (base must end with /)
    function resolveUrl(possibleUrl, base) {
      if (!possibleUrl) return possibleUrl;
      if (/^https?:\/\//i.test(possibleUrl) || possibleUrl.startsWith('/')) return possibleUrl;
      // make sure base ends with slash
      if (!base.endsWith('/')) base = base + '/';
      return base + possibleUrl;
    }

    // Apply website.json site-wide data (footerText, defaultCover). Find website.json by searching parents.
    async function loadWebsiteJson() {
      try {
        const { json: siteJson, url } = await fetchJsonFromParents('website.json', 8);
        const base = url.replace(/website\.json$/i, '');
        // footerText
        if (siteJson.footerText) {
          document.getElementById('site-footer').textContent = siteJson.footerText;
          // mark footer as locked so remote social.json won't override
          document.getElementById('site-footer').dataset.locked = '1';
        }
        // return site defaults, resolving defaultCover relative to website.json location
        const siteDefaultCover = siteJson.defaultCover ? resolveUrl(siteJson.defaultCover, base) : null;
        return { siteJson, siteBase: base, siteDefaultCover };
      } catch (err) {
        // no website.json found — not fatal
        console.warn('website.json not found (searched parents). Using defaults.', err);
        return { siteJson: null, siteBase: null, siteDefaultCover: null };
      }
    }

    // Apply remote social.json branding (colors, icons, banners). Returns remoteBannerUrl (2x1) absolute if found.
    async function loadSocialJson() {
      try {
        const SOCIAL_URL = 'https://periandevelopment.github.io/Socials/social.json';
        const { json: socialJson, url } = await fetchJsonAbsolute(SOCIAL_URL);
        const colors = (socialJson && socialJson.colors) || {};
        const icons = (socialJson && socialJson.icons) || {};
        const banners = (socialJson && socialJson.banners) || {};
        const identity = (socialJson && socialJson.identity) || {};

        if (colors.primary_hex) document.documentElement.style.setProperty('--brand', colors.primary_hex);
        if (colors.background_hex) document.documentElement.style.setProperty('--bg', colors.background_hex);
        if (colors.text_hex) document.documentElement.style.setProperty('--text', colors.text_hex);

        if (Array.isArray(colors.gradient_hex) && colors.gradient_hex.length >= 2) {
          const g = colors.gradient_hex.slice(0,2).join(', ');
          document.querySelector('.banner').style.background = `linear-gradient(90deg, ${g})`;
        }

        // Prefer icon_transparent, else icon. Only replace if provided.
        const iconImg = document.getElementById('brand-icon');
        if (icons.icon_transparent) iconImg.src = icons.icon_transparent;
        else if (icons.icon) iconImg.src = icons.icon;

        if (identity.display_name) document.getElementById('brand-name').textContent = identity.display_name;
        if (identity.tagline) document.getElementById('brand-tagline').textContent = identity.tagline;
        if (identity.bio) document.getElementById('bio').textContent = identity.bio;

        // remote banner 2x1 (may be absolute)
        return banners['2x1'] || null;
      } catch (err) {
        console.warn('Could not fetch remote social.json; continuing with defaults.', err);
        return null;
      }
    }

    // Fetch projects.json (from the current folder). We use fetchJsonFromParents only if needed,
    // but typically projects.json sits next to each page, so we try current folder first.
    async function loadProjectsJson() {
      // We will try: ./projects.json first, then search parents (to be robust)
      try {
        // try current folder
        let res = await fetch('projects.json', {cache: 'no-cache'});
        if (res.ok) {
          const json = await res.json();
          return { projects: json, base: res.url.replace(/projects\.json$/i,'') };
        }
      } catch (e) { /* ignore */ }

      // fallback: search parents
      try {
        const { json, url } = await fetchJsonFromParents('projects.json', 8);
        return { projects: json, base: url.replace(/projects\.json$/i,'') };
      } catch (err) {
        throw new Error('projects.json not found in current folder or parents.');
      }
    }

    // Render projects. Resolution order for cover:
    // project.cover -> project.icon_url -> projects.json base + relative -> remoteBanner -> website.defaultCover -> fallback.png
    function renderProjects(projects, projectsBase, remoteBanner, siteDefaultCover) {
      const fallback = 'fallback.png';
      const linksContainer = document.getElementById('project-links');
      const projectsContainer = document.getElementById('projects-container');
      linksContainer.innerHTML = '';
      projectsContainer.innerHTML = '';

      projects.forEach(p => {
        const linkHref = p.link || p.website || '#';

        // top text link (open same tab)
        const a = document.createElement('a');
        a.className = 'game-link';
        a.href = linkHref;
        a.textContent = p.title || p.name || p.id || 'Project';
        linksContainer.appendChild(a);

        // project card
        const card = document.createElement('article');
        card.className = 'project';
        card.id = p.id || (`project-${Math.random().toString(36).slice(2,9)}`);

        const head = document.createElement('div');
        head.className = 'project-head';
        const title = document.createElement('h3');
        title.className = 'project-title';
        title.textContent = p.title || p.name || p.id || 'Project';
        const year = document.createElement('div');
        year.className = 'project-year';
        year.textContent = p.year || '';

        head.appendChild(title);
        head.appendChild(year);
        card.appendChild(head);

        const coverLink = document.createElement('a');
        coverLink.className = 'cover-link';
        coverLink.href = linkHref;

        const cover = document.createElement('div');
        cover.className = 'cover';

        // compute cover URL with robust resolution
        let coverUrl = null;
        if (p.cover) coverUrl = p.cover;
        else if (p.icon_url) coverUrl = p.icon_url;

        // if coverUrl exists and is relative, resolve relative to projectsBase
        if (coverUrl && !/^https?:\/\//i.test(coverUrl) && !coverUrl.startsWith('/')) {
          if (projectsBase) coverUrl = projectsBase + coverUrl;
        }

        // if still no coverUrl, try remoteBanner (if relative, it is left as-is since social.json gives absolute URL)
        if (!coverUrl && remoteBanner) coverUrl = remoteBanner;
        // if still not, try siteDefaultCover (already resolved to absolute by loadWebsiteJson)
        if (!coverUrl && siteDefaultCover) coverUrl = siteDefaultCover;
        // fallback final
        if (!coverUrl) coverUrl = fallback;

        cover.style.backgroundImage = `url("${coverUrl}")`;

        const ctitle = document.createElement('div');
        ctitle.className = 'cover-title';
        ctitle.textContent = p.title || p.name || '';
        cover.appendChild(ctitle);
        coverLink.appendChild(cover);
        card.appendChild(coverLink);

        const meta = document.createElement('div');
        meta.className = 'meta';

        const mk = (label, valueHtml) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'meta-item';
          wrapper.innerHTML = `<span class="label">${label}</span><span class="value">${valueHtml}</span>`;
          return wrapper;
        };

        const projectHref = linkHref;
        const linkText = p.linkText || '';
        meta.appendChild(mk('Link', `<a class="reset" href="${projectHref}">${linkText}</a>`));
        meta.appendChild(mk('Studio', `${p.studio || ''}`));
        meta.appendChild(mk('Team size', `${p.teamSize || p.team_size || ''}`));
        meta.appendChild(mk('My contribution', `${p.contribution || ''}`));
        meta.appendChild(mk('Platform', `${p.platform || ''}`));
        meta.appendChild(mk('Engine & Tools', `${p.engineTools || p.engine_tools || ''}`));

        card.appendChild(meta);
        projectsContainer.appendChild(card);
      });
    }

    // Initialize sequence:
    // 1) read website.json (search parents) -> apply footerText and resolve siteDefaultCover
    // 2) read remote social.json -> apply brand colors/icon/name/tagline and get remote banner
    // 3) read projects.json (search parents) -> render projects with resolution order as above
    (async function init() {
      // 1) website.json
      const { siteJson, siteBase, siteDefaultCover } = await (async () => {
        try {
          const res = await fetchJsonFromParents('website.json', 8);
          const siteJson = res.json;
          const base = res.url.replace(/website\.json$/i,'');
          // footer
          if (siteJson.footerText) {
            document.getElementById('site-footer').textContent = siteJson.footerText;
            document.getElementById('site-footer').dataset.locked = '1';
          }
          const resolvedDefault = siteJson.defaultCover ? resolveUrl(siteJson.defaultCover, base) : null;
          return { siteJson, siteBase: base, siteDefaultCover: resolvedDefault };
        } catch (err) {
          return { siteJson: null, siteBase: null, siteDefaultCover: null };
        }
      })();

      // 2) remote social.json (branding)
      const remoteBanner = await (async () => {
        try {
          const res = await fetchJsonAbsolute('https://periandevelopment.github.io/Socials/social.json');
          const socialJson = res.json;
          const colors = (socialJson && socialJson.colors) || {};
          const icons = (socialJson && socialJson.icons) || {};
          const banners = (socialJson && socialJson.banners) || {};
          const identity = (socialJson && socialJson.identity) || {};

          if (colors.primary_hex) document.documentElement.style.setProperty('--brand', colors.primary_hex);
          if (colors.background_hex) document.documentElement.style.setProperty('--bg', colors.background_hex);
          if (colors.text_hex) document.documentElement.style.setProperty('--text', colors.text_hex);

          if (Array.isArray(colors.gradient_hex) && colors.gradient_hex.length >= 2) {
            const g = colors.gradient_hex.slice(0,2).join(', ');
            document.querySelector('.banner').style.background = `linear-gradient(90deg, ${g})`;
          }

          const iconImg = document.getElementById('brand-icon');
          // prefer icon_transparent
          if (icons.icon_transparent) iconImg.src = icons.icon_transparent;
          else if (icons.icon) iconImg.src = icons.icon;

          if (identity.display_name) document.getElementById('brand-name').textContent = identity.display_name;
          if (identity.tagline) document.getElementById('brand-tagline').textContent = identity.tagline;
          if (identity.bio) document.getElementById('bio').textContent = identity.bio;

          return banners['2x1'] || null;
        } catch (err) {
          console.warn('social.json load failed', err);
          return null;
        }
      })();

      // 3) projects.json
      try {
        // try current folder then parents
        let projectsData, projectsBase;
        try {
          // try current folder
          const res = await fetch('projects.json', {cache:'no-cache'});
          if (!res.ok) throw new Error('not found here');
          projectsData = await res.json();
          projectsBase = res.url.replace(/projects\.json$/i,'');
        } catch (_) {
          const res2 = await fetchJsonFromParents('projects.json', 8);
          projectsData = res2.json;
          projectsBase = res2.url.replace(/projects\.json$/i,'');
        }
        const effectiveSiteDefault = siteDefaultCover || null;
        renderProjects(projectsData, projectsBase, remoteBanner, effectiveSiteDefault);
      } catch (err) {
        console.error('Failed to load projects.json', err);
        const container = document.getElementById('projects-container');
        container.innerHTML = '<div style="color:var(--muted)">Failed to load projects. Check projects.json in the same folder or a parent folder.</div>';
      }
    })();
  </script>
</body>
</html>
